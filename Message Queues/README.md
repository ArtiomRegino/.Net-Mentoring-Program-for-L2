# Задание к модулю Windows Services.

Служба обработки результатов потокового сканирования

При массовом сканировании документов довольно часто используется следующая схема работы:

* Потоковый сканер (сканер с автоподачей бумаги) выдает последовательность изображений, которые сохраняются в папку на локальном компьютере или в сети (чаще всего это последовательность вида img_001.jpeg, img_002.jpeg, …)

* За этой папкой (или папками – их может быть несколько, если используется несколько потоковых сканеров) следит специальная программа, которая:

o Разделяет поток изображений на отдельные документы

o Собирает и сохраняет их в виде многостраничного файла (обычно это PDF, многостраничный TIFF или XPS)

o Передает их для дальнейшей обработки (пересылает по почте, заносит в СЭД, просто складывает в другую папку)

Для того, чтобы разделять последовательность листов на отдельные документы, обычно используют листы или наклейки со штрих-кодами. В самом просто сценарии это выглядит так:

* Между сканируемыми документами кладется листок со штрих-кодом (его подбирают так, чтобы он гарантированно не встретился в документах)

* Как только служба обрабатывающая последовательность встречает изображение нужного ей штрих-кода, она понимает, что предыдущий документ закончился и начинается новая последовательность страниц.

В данном задании мы создаем упрощенный вариант такой службы.

Пункты со звездочкой (*) являются необязательными – делать их только по согласованию с ментором.

## Задание 1

- [X] Разработать службу «склейки», результатов работы потокового сканера в единый PDF (или XPS) файл.

Служба должна уметь следующее:

* Следить за одной или несколькими папками на диске или в сети

* При появлении в папках изображений, подходящих именами под шаблон <префикс>_<номер>.<png|jpeg|…> собирать последовательность страниц и сохранять их как единый документ в отдельную папку.

* При запуске просматривать папки для мониторинга и при наличии там подходящих файлов также объединять их в документ.

В качестве признака «конца документа» предлагается использовать следующие:

* «Перескок» нумерации документов (т.е. img_001.jpeg, img_002.jpeg, img_004.jpeg – это два документа из 2 и 1 страниц)

* Истек таймаут появления следующей страницы

* (*) На очередной странице обнаружен штрих-код с определенным значением

Примечание! Прежде чем приступать к заданию, обсудите с ментором следующие моменты:

* В каком формате будут сохраняться документы: o PDF (можно, например, использовать связку библиотек PdfShar+MigraDoc) o XPS (используя стандартный FixedDocument)

o Многостраничный TIFF (например, как описано в http://stackoverflow.com/questions/398388/convert-bitmaps-to-one-multipage-tiff-image-in-net-2-0)

* Будете ли реализовывать функционал «разделение по штрих-коду» (например, на основе библиотеки ZXing.Net)

* На базе какого фреймворка вы будете реализовывать службу: System.ServiceProcess или Topshelf.

## Задание 2

- [X] Проверьте, что ваша служба корректно обрабатывает следующие ситуации:

* Исходный файл, который вам нужно обработать занят другим процессом (обычно делают несколько попыток открыть и только после их истечения – ошибка)

* Пришла команда остановки службы во время длительной операции (например, собирания многостраничного файла из множества страниц)

* Одна или несколько страниц для многостраничного файла оказались «битыми» (например, неверный формат). Возможная реакция – перемещение всей последовательности в отдельную папку «битых», для дальнейшей ручной корректировки.







#Задание к модулю Messaging

## Общее

В данной работе мы несколько расширим службу обработки результатов потокового сканирования, которую разрабатывали в модуле Windows Services.

Традиционно принято подобного рода системы разбивать на отдельные независимые службы, которые могут устанавливаться как на один компьютер, так и на разные. Например, может существовать следующая конфигурация:

* Сервера захвата (ввода) документов. Обычно их бывает несколько, и они устанавливаются на разные компьютеры – туда, где происходит ввод документов (изображений). Их задача – собирать документы и передавать на сервера трансформации

* Сервера трансформации. Их также может быть несколько, но по другой причине – таким образом балансируют нагрузку. Такие сервера могут производить различные типы обработок: конвертация, извлечение текста (OCR), отправка в СЭД, …

* Центральный управляющий сервер. Как правило он один и его задача – мониторинг состояния работы остальных серверов и передавать им настройки.

Мы будем реализовывать чуть более простую модель, состоящей из 2-х элементов: служб ввода (на базе уже реализованной службы для потокового сканирования) и центрального сервера.

Примечание!!! Прежде чем приступать к выполнению задания, рекомендуется обсудить с ментором детали реализации:

* Какую(ие) использовать очередь(и) сообщений (MSMQ/RabbitMQ/…)

* Архитектуру решения (где, сколько и каких очередей использовать, …).

## Задание 1. Централизация сбора результатов работы служб ввода

- [X] Разработай службу центрального сервера, которая будет делать следующее:

* При установке (или первом запуске) создавать очередь для приема результатов (готовых документов) от служб ввода

* Слушает эту входящую очередь и сохраняет на диск все пришедшие документы

Доработайте службу ввода так, чтобы вместо того, чтобы сохранять готовые документы на диск, она отсылала их через службу сообщений на центральный сервер.

Для упрощения архитектуры примем, что в сети одновременно могут работать несколько агентов (на разных компьютерах), но только 1 центральный сервис.

Примечание!!! Одна из сложностей данного задания: лимит на размер одного сообщения. Суть в том, что как правило, очереди сообщений лимитируют размер одного сообщения (особенно это касается облачных платформ) и получаемый файл, скорее всего, этим лимитам удовлетворять не будет.

Для пересылки больших объемов данных в очереди (там, где имеется лимит и невозможно использовать другие способы передачи) используется подход Message Sequence (по ссылке приведен только рисунок, но общую идею он проясняет).

Обсудите с ментором, какой вариант борьбы с ограничением на размер сообщения вы выберите.

## Задание 2. Механизм централизованного контроля и управления

- [X] Разработайте механизм централизованного управления через очереди сообщений.

В рамках этого механизма:

* От служб ввода на центральный сервер с некоторой периодичностью приходит текущий статус службы:

o Чем занята служба (ждет новых файлов/обрабатывает последовательность/…)

o Текущие настройки:

* Таймаут ожидания очередной страниц

* Значение штрих-кода, который является разделителем потока

* От сервера ко всем службам уходят команды:

o Обновить статус (т.е. не дожидаясь времени обновления статуса)

o Поменять настройки:

* Таймаут ожидания очередной страниц

* Значение штрих-кода, который является разделителем потока

Для упрощения предлагается не разрабатывать никакого UI, а сделать всё на файлах (хотя это не обязательное требование – если удобнее разработать UI, то можно сделать и так):

* Статусы служб центральный сервер сохраняет в XML/CSV файл

* Для рассылки новых настроек просто следит за обновлением локального файла с настройками – если он поменялся, то рассылает новые настройки.